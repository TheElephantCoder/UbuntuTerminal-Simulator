<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pyodide Terminal Simulator</title>
    <link rel="icon" href="favicon.ico">
    <style>
        body {
            background: #1e1e1e;
            color: #c0c0c0;
            font-family: monospace;
            padding: 0;
            margin: 0;
        }
        #terminal {
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .line {
            display: flex;
            align-items: baseline;
        }
        .prompt {
            color: #4caf50;
        }
        .input {
            color: #ffffff;
            flex: 1;
        }
    </style>
</head>
<body>
    <div id="terminal"></div>

    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script>
        const terminal = document.getElementById("terminal");
        let pyodide = null;

        // Simulated shell command outputs
        const fakeCommandOutputs = {
            "ls": "main.py  requirements.txt  README.md  .gitignore",
            "pwd": "/home/user",
            "whoami": "user",
            "cd": "",
            "cat": "Simulated file contents...",
            "touch": "",
            "mkdir": "",
            "rm": "",
            "rmdir": "",
            "echo": "",
            "man": "No manual entry for this command.",
            "ps": "PID TTY          TIME CMD\n1234 pts/0    00:00:00 bash\n5678 pts/0    00:00:00 python",
            "top": "top - 00:00:01 up  1:23,  1 user,  load average: 0.05, 0.06, 0.01\nTasks:   1 total,   1 running,   0 sleeping,   0 stopped,   0 zombie",
            "grep": "",
            "curl": "curl: try 'curl --help' or 'curl --manual' for more information",
            "ping": "PING github.com (140.82.114.3): 56 data bytes\n64 bytes from 140.82.114.3: icmp_seq=0 ttl=52 time=17.942 ms",
        };

        async function initPyodide() {
            pyodide = await loadPyodide();
            createLine("Welcome to the Ubuntu Terminal Simulator! Type Python code or 'exit' to quit.\n");
            createPromptLine();
        }

        function createLine(text = "") {
            const line = document.createElement("div");
            line.textContent = text;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
        }

        function createPromptLine() {
            const line = document.createElement("div");
            line.className = "line";

            const prompt = document.createElement("span");
            prompt.className = "prompt";
            prompt.textContent = "user@pyodide:~$ ";

            const input = document.createElement("span");
            input.className = "input";
            input.contentEditable = true;
            input.spellcheck = false;

            line.appendChild(prompt);
            line.appendChild(input);
            terminal.appendChild(line);

            input.focus();
            handleInput(input);
        }

        function handleInput(input) {
            input.addEventListener("keydown", async (event) => {
                if (event.key === "Enter") {
                    event.preventDefault();
                    const command = input.textContent.trim();
                    input.contentEditable = false;

                    if (command === "exit") {
                        createLine("Exiting Pyodide Terminal. Goodbye!");
                        return;
                    }

                    // Special handling for 'clear'
                    if (command.split(" ")[0] === "clear") {
                        await executeCommand(command); // Handles clearing and prompt
                        // Do not create another prompt!
                        return;
                    }

                    await executeCommand(command);
                    createPromptLine();
                }
            });
        }

        async function executeCommand(command) {
            createLine("user@pyodide:~$ " + command);

            // Extract the base command and args
            const [cmdName, ...args] = command.split(" ");

            // Handle 'clear'
            if (cmdName === "clear") {
                terminal.innerHTML = "";
                createPromptLine();
                return;
            }

            // Handle fake shell commands
            if (Object.keys(fakeCommandOutputs).includes(cmdName)) {
                let output = fakeCommandOutputs[cmdName];

                // For echo, print the arguments
                if (cmdName === "echo") {
                    output = args.join(" ");
                }

                // For cat, print file name or simulated content
                if (cmdName === "cat" && args.length) {
                    output = `Contents of ${args[0]}: Hello from your fake terminal!`;
                }

                // For commands that shouldn't output anything, don't create an empty line
                if (output !== "") {
                    createLine(output);
                }
                return;
            }

            // Try running as Python
            try {
                const result = await pyodide.runPythonAsync(command);
                if (result !== undefined && result !== null && result.toString().trim() !== "") {
                    createLine(result.toString());
                } else {
                    createLine("Python code executed successfully.");
                }
            } catch (error) {
                const lines = (error.message || "").split('\n');
                let lastLine = '';
                for (let i = lines.length - 1; i >= 0; i--) {
                    if (lines[i].trim() !== '') {
                        lastLine = lines[i].trim();
                        break;
                    }
                }
                createLine(`Error: ${lastLine}`);
            }
        }

        // Initialize the terminal
        initPyodide();
    </script>
</body>
</html>
